<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Creador - Barbería SaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script> 
<!-- html2pdf para PDFs profesionales -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }
    
    /* Estilos para impresión/PDF */
    @media print {
        .page-break-after {
            page-break-after: always;
        }
        .page-break-before {
            page-break-before: always;
        }
        .avoid-break {
            page-break-inside: avoid;
        }
    }
    
    /* Asegurar que los colores de Tailwind se vean en PDF */
    .bg-green-50 { background-color: #f0fdf4 !important; }
    .bg-blue-50 { background-color: #eff6ff !important; }
    .bg-yellow-50 { background-color: #fefce8 !important; }
    .bg-orange-50 { background-color: #fff7ed !important; }
    .bg-purple-50 { background-color: #faf5ff !important; }
    .bg-red-50 { background-color: #fef2f2 !important; }
    .bg-gray-50 { background-color: #f9fafb !important; }
    
    .text-green-600 { color: #16a34a !important; }
    .text-blue-600 { color: #2563eb !important; }
    .text-yellow-600 { color: #ca8a04 !important; }
    .text-orange-600 { color: #ea580c !important; }
    .text-purple-600 { color: #9333ea !important; }
    .text-red-600 { color: #dc2626 !important; }
    
    .border-green-200 { border-color: #bbf7d0 !important; }
    .border-blue-200 { border-color: #bfdbfe !important; }
    .border-yellow-200 { border-color: #fef08a !important; }
    .border-orange-200 { border-color: #fed7aa !important; }
    .border-purple-200 { border-color: #e9d5ff !important; }
    .border-red-200 { border-color: #fecaca !important; }
</style>
</head>
</head>
<body class="bg-gray-50">
    <!-- PANTALLA DE SELECCIÓN INICIAL -->
    <div id="pantallaSeleccion" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-purple-600 to-indigo-700">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <i class="fas fa-crown text-6xl text-purple-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">Sistema de Gestión</h1>
                <p class="text-gray-600 mt-2">Selecciona dónde ingresar</p>
            </div>
            
            <div class="mb-4">
                <button onclick="mostrarLoginCreador()" class="w-full bg-purple-600 text-white py-4 rounded-lg font-semibold hover:bg-purple-700">
                    <i class="fas fa-crown mr-2"></i>Panel del Creador
                    <p class="text-sm font-normal mt-1">Administración general</p>
                </button>
            </div>
            
            <div>
                <button onclick="window.location.href='index.html'" class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-700">
                    <i class="fas fa-store mr-2"></i>Sistema Barbería
                    <p class="text-sm font-normal mt-1">Para usuarios de barberías</p>
                </button>
            </div>
            
            <div id="formularioLogin" class="hidden mt-6 pt-6 border-t">
                <h3 class="text-lg font-bold mb-4">Ingreso Panel del Creador</h3>
                <form onsubmit="validarLogin(event)">
                    <input type="password" id="passwordCreador" class="w-full px-4 py-2 border rounded-lg mb-3" placeholder="Contraseña" required>
                    <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">Entrar</button>
                </form>
                <button onclick="ocultarLoginCreador()" class="w-full mt-2 text-gray-600">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- PANEL EXISTENTE (agregar hidden) -->
    <div id="panelCreador" class="min-h-screen hidden">
        <!-- Header -->
        <nav class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">
                        <i class="fas fa-crown mr-2"></i>Panel del Creador
                    </h1>
<button onclick="cerrarSesion()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
    <i class="fas fa-sign-out-alt mr-2"></i>Salir
</button>
                </div>
            </div>
        </nav>

 <!-- Contenido Principal -->
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Tabs de navegación -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-1 p-1">
                <button onclick="mostrarTab('dashboard')" id="tab-dashboard" 
                    class="tab-btn bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button onclick="mostrarTab('barberias')" id="tab-barberias" 
                    class="tab-btn text-gray-600 hover:text-gray-800 px-4 py-2 rounded-lg font-medium">
                    <i class="fas fa-store mr-2"></i>Barberías
                </button>
                <button onclick="mostrarTab('facturacion')" id="tab-facturacion" 
                    class="tab-btn text-gray-600 hover:text-gray-800 px-4 py-2 rounded-lg font-medium">
                    <i class="fas fa-dollar-sign mr-2"></i>Facturación
                </button>
                <button onclick="mostrarTab('reportes')" id="tab-reportes" 
                    class="tab-btn text-gray-600 hover:text-gray-800 px-4 py-2 rounded-lg font-medium">
                    <i class="fas fa-file-alt mr-2"></i>Reportes
                </button>
            </nav>
        </div>
    </div>

    <!-- Contenido de Dashboard -->
    <div id="content-dashboard" class="tab-content">
        <!-- Botón para ir al Sistema de Barbería -->
<div class="mb-6 text-center">
    <button onclick="window.open('index.html', '_blank')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
        <i class="fas fa-store mr-2"></i>Ir a Sistema Barbería
    </button>
    <p class="text-sm text-gray-600 mt-2">Abre el sistema de barbería en una nueva pestaña para probar</p>
</div>
        <!-- Métricas Generales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">Total Barberías</div>
                <div class="text-3xl font-bold text-blue-600" id="totalBarberias">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">Activas</div>
                <div class="text-3xl font-bold text-green-600" id="barberiasActivas">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">En Trial</div>
                <div class="text-3xl font-bold text-yellow-600" id="barberiasEnTrial">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">Ingresos/Mes</div>
                <div class="text-3xl font-bold text-purple-600" id="ingresosMensuales">$0</div>
            </div>
        </div>

        <!-- Gráficos y más métricas aquí -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-bold mb-4">📊 Actividad Reciente</h3>
            <p class="text-gray-600">Últimas barberías registradas, últimos pagos, etc.</p>
        </div>
    </div>

    <!-- Contenido de Barberías -->
    <div id="content-barberias" class="tab-content hidden">
        <!-- Botón Nueva Barbería -->
        <div class="mb-6">
            <button onclick="mostrarModalNuevaBarberia()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                <i class="fas fa-plus mr-2"></i>Nueva Barbería
            </button>
        </div>

        <!-- Tabla de Barberías -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b">
                <h2 class="text-xl font-bold">Gestión de Barberías</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Barbería</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trial Hasta</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuarios</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaBarberias" class="bg-white divide-y divide-gray-200">
                        <!-- Se llenará dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Contenido de Facturación -->

<div id="content-facturacion" class="tab-content hidden">
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-bold mb-4">💰 Control de Facturación</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-green-50 p-4 rounded-lg">
                <div class="text-sm text-green-600">Cobrado este mes</div>
                <div class="text-2xl font-bold text-green-900" id="cobradoMes">$0</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <div class="text-sm text-yellow-600">Por cobrar (trials vencidos)</div>
                <div class="text-2xl font-bold text-yellow-900" id="porCobrar">$0</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg">
                <div class="text-sm text-red-600">Trials por vencer (7 días)</div>
                <div class="text-2xl font-bold text-red-900" id="trialsProximos">0</div>
            </div>
        </div>
    </div>

    <!-- Tabla de Estado de Pagos -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-bold">Estado de Pagos por Barbería</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Barbería</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado Pago</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vencimiento</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaFacturacion" class="bg-white divide-y divide-gray-200">
                    <!-- Se llenará dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>
    <!-- Contenido de Reportes -->
<div id="content-reportes" class="tab-content hidden">
    <!-- Resumen rápido -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="text-sm text-gray-600">Servicios Totales</div>
            <div class="text-2xl font-bold text-blue-600" id="serviciosTotales">0</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="text-sm text-gray-600">Usuarios Activos</div>
            <div class="text-2xl font-bold text-green-600" id="usuariosActivos">0</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="text-sm text-gray-600">Tasa Conversión</div>
            <div class="text-2xl font-bold text-purple-600" id="tasaConversion">0%</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="text-sm text-gray-600">Promedio x Barbería</div>
            <div class="text-2xl font-bold text-orange-600" id="promedioPorBarberia">$0</div>
        </div>
    </div>

    <!-- Reporte de Trials por Vencer -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-lg font-bold mb-4">⏰ Trials Próximos a Vencer (próximos 15 días)</h3>
        <div id="trialsVenciendo" class="space-y-2">
            <!-- Se llenará dinámicamente -->
        </div>
    </div>

    <!-- Top Barberías por Actividad -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-bold mb-4">🏆 Top 5 Barberías por Actividad</h3>
        <div id="topBarberias" class="space-y-2">
            <!-- Se llenará dinámicamente -->
        </div>
    </div>
    <!-- Sección Backup Avanzado -->
        <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg shadow border-2 border-blue-200 mt-6">
            <div class="px-6 py-4 border-b border-blue-200 bg-gradient-to-r from-blue-500 to-green-500 text-white">
                <h3 class="text-lg font-bold flex items-center">
                    <i class="fas fa-download mr-2"></i>
                    Backup y Exportación de Datos
                </h3>
                <p class="text-blue-100 text-sm mt-1">Exporta datos completos de cualquier barbería</p>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Selector Barbería -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Barbería:</label>
                        <select id="selectBarberiaBackup" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccionar barbería...</option>
                        </select>
                    </div>
                    
                    <!-- Tipo de datos -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Incluir:</label>
                        <select id="tipoBackup" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="completo">📊 Backup Completo</option>
                            <option value="usuarios">👥 Solo Usuarios</option>
                            <option value="servicios">✂️ Solo Servicios</option>
                            <option value="reservas">📅 Solo Reservas</option>
                            <option value="adelantos">💰 Solo Adelantos</option>
                        </select>
                    </div>
                    
                    <!-- Formato -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Formato:</label>
                        <select id="formatoBackup" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="excel">📊 Excel (.xlsx)</option>
                            <option value="csv">📄 CSV (.csv)</option>
                            <option value="json">🔧 JSON (.json)</option>
                        </select>
                    </div>
                    
                    <!-- Botón Exportar -->
                    <div class="flex items-end">
                        <button onclick="exportarBackupAvanzado()" 
                            class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-2 px-4 rounded-lg hover:from-green-600 hover:to-blue-600 font-semibold">
                            📥 Exportar
                        </button>
                    </div>
                </div>
                
                <!-- Info adicional -->
                <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                        <div class="text-sm text-gray-700">
                            <p class="font-medium mb-1">💡 Casos de uso recomendados:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-600">
                                <li><strong>Backup Completo:</strong> Antes de eliminar barbería</li>
                                <li><strong>Solo Servicios:</strong> Análisis de productividad</li>
                                <li><strong>Solo Reservas:</strong> Exportar agenda a Excel</li>
                                <li><strong>Formato Excel:</strong> Para análisis y gráficos</li>
                                <li><strong>Formato CSV:</strong> Para importar en otros sistemas</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>
<!-- Modal Eliminar Barbería -->
<div id="modalEliminarBarberia" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-red-600">⚠️ Eliminar Barbería</h3>
            <button onclick="cerrarModalEliminar()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="resumenEliminacion" class="mb-6">
            <!-- Se llenará dinámicamente -->
        </div>
        
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2 mt-1"></i>
                <div class="text-sm text-red-700">
                    <strong>Esta acción NO se puede deshacer.</strong><br>
                    Todos los datos se eliminarán permanentemente.
                </div>
            </div>
        </div>
        
        <div class="flex space-x-3">
            <button onclick="cerrarModalEliminar()" 
                class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                Cancelar
            </button>
            <button onclick="confirmarEliminacion()" 
                class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-bold">
                🗑️ Sí, eliminar todo
            </button>
        </div>
        
        <!-- Loading durante eliminación -->
        <div id="loadingEliminacion" class="hidden mt-4 text-center">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
            <p class="text-sm text-gray-600 mt-2">Eliminando datos...</p>
        </div>
    </div>
</div>
    <!-- Modal Nueva Barbería -->
    <div id="modalNuevaBarberia" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Nueva Barbería</h3>
            <form id="formNuevaBarberia">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Barbería</label>
                        <input type="text" id="nombreBarberia" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email del Admin</label>
                        <input type="email" id="emailAdmin" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Admin</label>
                        <input type="text" id="nombreAdmin" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Días de Trial</label>
                        <input type="number" id="diasTrial" value="15" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="cerrarModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                        Crear
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
        <!-- Modal Consultor IA -->
<div id="modalConsultorIA" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 rounded-t-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-bold flex items-center">
                        <i class="fas fa-brain mr-3"></i>
                        Consultor IA
                    </h3>
                    <p id="nombreBarberiaIA" class="text-purple-100 mt-1"></p>
                </div>
                <button onclick="cerrarModalIA()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Loading -->
            <div id="loadingIA" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
                <p class="text-gray-600">Analizando datos...</p>
            </div>
            
<!-- Contenido del Análisis -->
<div id="contenidoIA" class="hidden">
    
    <!-- Header del PDF -->
    <div id="headerPDF" class="hidden print:block bg-white p-6 mb-6">
        <div class="text-center border-b-4 border-purple-600 pb-4">
            <h1 class="text-3xl font-bold text-purple-600 mb-2">📊 INFORME COMPLETO - CONSULTOR IA</h1>
            <h2 id="nombreBarberiaPDF" class="text-2xl font-semibold text-gray-800"></h2>
            <p class="text-gray-500 mt-2">
                Fecha: <span id="fechaPDF"></span> | Análisis: Últimos 30 días
            </p>
        </div>
    </div>
    
    <!-- ========== SECCIÓN 1: RESUMEN EJECUTIVO ========== -->
    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-6 mb-6 shadow-lg border-2 border-purple-200 page-break-after">
        <h3 class="text-2xl font-bold mb-6 text-purple-700 flex items-center">
            <span class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">1</span>
            Resumen Ejecutivo
        </h3>
        
        <!-- Salud del Negocio -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow-md">
            <h4 class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-heartbeat text-red-500 mr-3"></i>
                Salud del Negocio
            </h4>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div id="emojiSaludIA" class="text-6xl mb-2">🟡</div>
                    <div id="puntajeSaludIA" class="text-4xl font-bold mb-2">--/100</div>
                    <div id="mensajeSaludIA" class="text-sm text-gray-600"></div>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total Servicios:</span>
                        <span id="totalServiciosPDF" class="font-bold">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ingresos Totales:</span>
                        <span id="totalIngresosPDF" class="font-bold text-green-600">$--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Ticket Promedio:</span>
                        <span id="ticketPromedioPDF" class="font-bold text-blue-600">$--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Servicios/día:</span>
                        <span id="serviciosDiaPDF" class="font-bold">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top 3 Recomendaciones Resumen -->
        <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
            <h4 class="font-bold mb-2 text-yellow-700">⚡ Acciones Prioritarias:</h4>
            <div id="resumenRecomendaciones" class="text-sm space-y-1">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>
    
    <!-- ========== SECCIÓN 2: ANÁLISIS DE INGRESOS ========== -->
    <div class="bg-white rounded-lg p-6 mb-6 shadow-lg border border-gray-200 page-break-after">
        <h3 class="text-2xl font-bold mb-6 text-green-700 flex items-center">
            <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">2</span>
            Análisis de Ingresos
        </h3>
        
        <!-- Ingresos por Forma de Pago -->
        <div class="mb-6">
            <h4 class="font-bold mb-3 flex items-center">
                <i class="fas fa-wallet mr-2 text-green-600"></i>
                Distribución por Forma de Pago
            </h4>
            <div id="formasPagoDetalle" class="space-y-2">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
        
        <!-- Análisis de Ticket -->
        <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-bold mb-3 flex items-center">
                <i class="fas fa-receipt mr-2 text-blue-600"></i>
                Análisis de Ticket Promedio
            </h4>
            <div id="ticketAnalisis" class="space-y-2 text-sm">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>
    
    <!-- ========== SECCIÓN 3: ANÁLISIS DE SERVICIOS ========== -->
    <div class="bg-white rounded-lg p-6 mb-6 shadow-lg border border-gray-200 page-break-after">
        <h3 class="text-2xl font-bold mb-6 text-indigo-700 flex items-center">
            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">3</span>
            Análisis de Servicios
        </h3>
        
        <!-- Top 5 Servicios -->
        <div class="mb-6">
            <h4 class="font-bold mb-3">🏆 Top 5 Servicios Más Vendidos</h4>
            <div id="top5Servicios" class="space-y-2">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
        
        <!-- Servicios Más Rentables -->
        <div class="bg-green-50 rounded-lg p-4">
            <h4 class="font-bold mb-3 text-green-700">💰 Servicios Más Rentables</h4>
            <div id="serviciosRentables" class="space-y-2 text-sm">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>
    
    <!-- ========== SECCIÓN 4: ANÁLISIS TEMPORAL ========== -->
    <div class="bg-white rounded-lg p-6 mb-6 shadow-lg border border-gray-200 page-break-after">
        <h3 class="text-2xl font-bold mb-6 text-orange-700 flex items-center">
            <span class="bg-orange-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">4</span>
            Análisis Temporal
        </h3>
        
        <!-- Por Día de Semana -->
        <div class="mb-6">
            <h4 class="font-bold mb-3">📅 Distribución por Día de la Semana</h4>
            <div id="distribucionDias" class="space-y-2">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
        
        <!-- Por Hora -->
        <div class="bg-orange-50 rounded-lg p-4">
            <h4 class="font-bold mb-3 text-orange-700">🕐 Distribución por Hora del Día</h4>
            <div id="distribucionHoras" class="space-y-2 text-sm">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>
    
    <!-- ========== SECCIÓN 5: ANÁLISIS DE BARBEROS ========== -->
    <div class="bg-white rounded-lg p-6 mb-6 shadow-lg border border-gray-200 page-break-after">
        <h3 class="text-2xl font-bold mb-6 text-purple-700 flex items-center">
            <span class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">5</span>
            Análisis de Barberos
        </h3>
        
        <!-- Ranking -->
        <div class="mb-6">
            <h4 class="font-bold mb-3">👑 Ranking de Productividad</h4>
            <div id="rankingBarberos" class="space-y-3">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
        
        <!-- Alertas -->
        <div id="alertasBarberos" class="space-y-2">
            <!-- Se llenará dinámicamente -->
        </div>
    </div>
    
    <!-- ========== SECCIÓN 6: OPORTUNIDADES ========== -->
    <div class="bg-white rounded-lg p-6 mb-6 shadow-lg border border-gray-200 page-break-after">
        <h3 class="text-2xl font-bold mb-6 text-yellow-700 flex items-center">
            <span class="bg-yellow-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">6</span>
            Oportunidades de Crecimiento
        </h3>
        
        <div id="recomendacionesIA" class="space-y-4">
            <!-- Se llenarán dinámicamente -->
        </div>
    </div>
    
    <!-- ========== SECCIÓN 7: PROYECCIONES ========== -->
    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6 shadow-lg border-2 border-green-200">
        <h3 class="text-2xl font-bold mb-6 text-green-700 flex items-center">
            <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">7</span>
            Proyecciones y Plan de Acción
        </h3>
        
        <!-- Proyección -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow-md">
            <h4 class="font-bold mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-green-600"></i>
                Predicción Próximo Mes
            </h4>
            <div class="grid grid-cols-2 gap-4 text-center mb-4">
                <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">Proyección Base:</p>
                    <p id="proyeccionIA" class="text-3xl font-bold text-green-600">$--</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">Con Mejoras (+10%):</p>
                    <p id="metaIA" class="text-3xl font-bold text-blue-600">$--</p>
                </div>
            </div>
            <p id="explicacionProyeccionIA" class="text-sm text-gray-600 text-center"></p>
        </div>
        
        <!-- Plan de Acción -->
        <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-bold mb-3 text-blue-700">📋 Plan de Acción - Próximos 7 Días</h4>
            <div id="planAccion" class="space-y-2 text-sm">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>
    
 <!-- Footer PDF -->
    <div class="hidden print:block mt-8 pt-6 border-t text-center text-gray-500 text-sm">
        <p>🧠 Generado por Consultor IA - Sistema Barbería SaaS</p>
        <p class="mt-1">Confidencial - Solo para uso interno de <span id="nombreBarberiaFooter"></span></p>
    </div>
</div>

        <!-- Footer con botón descargar -->
        <div class="bg-gray-50 p-6 rounded-b-lg border-t">
            <button onclick="descargarInformePDF()" 
                class="w-full bg-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-purple-700 shadow-lg flex items-center justify-center transition-colors">
                <i class="fas fa-download mr-3"></i>
                Descargar Informe Completo (PDF)
            </button>
        </div>
    </div>
</div>
    <script>
        
        // Configuración Supabase
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);





        async function cargarMetricas() {
            try {
                const { data: barberias, error } = await supabase
                    .from('barberias')
                    .select('*');

                if (!error && barberias) {
                    const total = barberias.length;
                    const activas = barberias.filter(b => b.activa).length;
                    const enTrial = barberias.filter(b => b.plan === 'trial' && b.activa).length;
                    const pagando = barberias.filter(b => b.plan === 'premium' && b.activa).length;
                    
                    document.getElementById('totalBarberias').textContent = total;
                    document.getElementById('barberiasActivas').textContent = activas;
                    document.getElementById('barberiasEnTrial').textContent = enTrial;
                    document.getElementById('ingresosMensuales').textContent = 
                        `$${(pagando * 15000).toLocaleString('es-CL')}`;
                }
            } catch (error) {
                console.error('Error cargando métricas:', error);
            }
        }

        async function cargarBarberias() {
            try {
                const { data: barberias, error } = await supabase
                    .from('barberias')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('tablaBarberias');
                tbody.innerHTML = '';

                for (const barberia of barberias) {
                    // Contar usuarios de cada barbería
                    const { count } = await supabase
                        .from('usuarios')
                        .select('*', { count: 'exact', head: true })
                        .eq('barberia_id', barberia.id);

                    const estadoBadge = barberia.activa 
                        ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Activa</span>'
                        : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Inactiva</span>';

                    const planBadge = barberia.plan === 'trial'
                        ? '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Trial</span>'
                        : '<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">Premium</span>';

                    const trialHasta = barberia.trial_hasta 
                        ? new Date(barberia.trial_hasta).toLocaleDateString('es-CL')
                        : 'N/A';

                    tbody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${barberia.nombre}</div>
                                <div class="text-xs text-gray-500">${barberia.id.substring(0, 8)}...</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">${planBadge}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${estadoBadge}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${trialHasta}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${count || 0} usuarios</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                               <button onclick="toggleBarberia('${barberia.id}', ${barberia.activa})" 
    class="mr-2 px-3 py-1 ${barberia.activa ? 'bg-red-500' : 'bg-green-500'} text-white rounded hover:opacity-80">
    ${barberia.activa ? 'Desactivar' : 'Activar'}
</button>
<button onclick="extenderTrial('${barberia.id}')" 
    class="mr-2 px-3 py-1 bg-blue-500 text-white rounded hover:opacity-80">
    +15 días
</button>
<button onclick="mostrarModalEliminar('${barberia.id}', '${barberia.nombre}')" 
    class="mr-2 px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 font-bold">
    🗑️ Eliminar
</button>
<button onclick="backupRapido('${barberia.id}', '${barberia.nombre}')" 
    class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm" 
    title="Backup rápido">
    📥
</button>
<button onclick="mostrarConsultorIA('${barberia.id}', '${barberia.nombre}')" 
    class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm" 
    title="Consultor IA">
    📊
</button>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function toggleBarberia(id, estadoActual) {
            const nuevoEstado = !estadoActual;
            const accion = nuevoEstado ? 'activar' : 'desactivar';
            
            if (!confirm(`¿Seguro que quieres ${accion} esta barbería?`)) return;

            try {
                // Actualizar barbería
                const { error: errorBarberia } = await supabase
                    .from('barberias')
                    .update({ activa: nuevoEstado })
                    .eq('id', id);

                // Actualizar usuarios
                const { error: errorUsuarios } = await supabase
                    .from('usuarios')
                    .update({ activo: nuevoEstado })
                    .eq('barberia_id', id);

                if (!errorBarberia && !errorUsuarios) {
                    alert(`✅ Barbería ${accion}da correctamente`);
                    cargarBarberias();
                    cargarMetricas();
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        async function extenderTrial(id) {
            if (!confirm('¿Extender trial por 15 días más?')) return;

            try {
                const nuevaFecha = new Date();
                nuevaFecha.setDate(nuevaFecha.getDate() + 15);

                const { error } = await supabase
                    .from('barberias')
                    .update({ 
                        trial_hasta: nuevaFecha.toISOString().split('T')[0],
                        plan: 'trial',
                        activa: true
                    })
                    .eq('id', id);

                if (!error) {
                    alert('✅ Trial extendido por 15 días');
                    cargarBarberias();
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        function mostrarModalNuevaBarberia() {
            document.getElementById('modalNuevaBarberia').classList.remove('hidden');
        }

        function cerrarModal() {
            document.getElementById('modalNuevaBarberia').classList.add('hidden');
            document.getElementById('formNuevaBarberia').reset();
        }

        document.getElementById('formNuevaBarberia').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nombre = document.getElementById('nombreBarberia').value;
            const emailAdmin = document.getElementById('emailAdmin').value;
            const nombreAdmin = document.getElementById('nombreAdmin').value;
            const diasTrial = document.getElementById('diasTrial').value;

            try {
                // Crear barbería
                const trialHasta = new Date();
                trialHasta.setDate(trialHasta.getDate() + parseInt(diasTrial));

                const { data: nuevaBarberia, error: errorBarberia } = await supabase
                    .from('barberias')
                    .insert({
                        nombre: nombre,
                        plan: 'trial',
                        trial_hasta: trialHasta.toISOString().split('T')[0],
                        activa: true
                    })
                    .select()
                    .single();

                if (errorBarberia) throw errorBarberia;

                // Crear usuario admin
                const { error: errorUsuario } = await supabase
                    .from('usuarios')
                    .insert({
                        email: emailAdmin,
                        nombre: nombreAdmin,
                        role: 'admin',
                        barberia_id: nuevaBarberia.id,
                        activo: true
                    });

                if (errorUsuario) throw errorUsuario;

                alert(`✅ Barbería creada exitosamente!\n\nCredenciales:\n📧 ${emailAdmin}\n🔑 123456`);
                cerrarModal();
                cargarBarberias();
                cargarMetricas();

            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        });
       async function cargarFacturacion() {
    try {
        const { data: barberias, error } = await supabase
            .from('barberias')
            .select('*')
            .eq('activa', true)
            .order('trial_hasta', { ascending: true });

        if (error) throw error;

        const hoy = new Date();
        let cobradoMes = 0;
        let porCobrar = 0;
        let trialsProximos = 0;
        
        const tbody = document.getElementById('tablaFacturacion');
        tbody.innerHTML = '';

        barberias.forEach(barberia => {
            // Calcular días hasta vencimiento
            const vencimiento = barberia.trial_hasta ? new Date(barberia.trial_hasta) : null;
            const diasRestantes = vencimiento ? Math.ceil((vencimiento - hoy) / (1000 * 60 * 60 * 24)) : null;
            
            let estadoPago = '';
            let badgeColor = '';
            
            if (barberia.plan === 'premium') {
                cobradoMes += 15000;
                estadoPago = 'Pagado';
                badgeColor = 'bg-green-100 text-green-800';
            } else if (diasRestantes && diasRestantes > 0) {
                if (diasRestantes <= 7) trialsProximos++;
                estadoPago = `Trial (${diasRestantes} días)`;
                badgeColor = diasRestantes <= 7 ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800';
            } else {
                porCobrar += 15000;
                estadoPago = 'Por cobrar';
                badgeColor = 'bg-red-100 text-red-800';
            }

            tbody.innerHTML += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${barberia.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${barberia.plan === 'premium' ? 
                            '<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">Premium</span>' :
                            '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Trial</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 py-1 text-xs rounded-full ${badgeColor}">${estadoPago}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${vencimiento ? vencimiento.toLocaleDateString('es-CL') : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${barberia.plan === 'trial' ? 
                            `<button onclick="convertirAPremium('${barberia.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600">
                                Marcar Pagado
                            </button>` : 
                            '<span class="text-gray-400">-</span>'}
                    </td>
                </tr>
            `;
        });

        // Actualizar métricas
        document.getElementById('cobradoMes').textContent = `$${cobradoMes.toLocaleString('es-CL')}`;
        document.getElementById('porCobrar').textContent = `$${porCobrar.toLocaleString('es-CL')}`;
        document.getElementById('trialsProximos').textContent = trialsProximos;

    } catch (error) {
        console.error('Error cargando facturación:', error);
    }
}

async function convertirAPremium(barberiaId) {
    if (!confirm('¿Confirmar que esta barbería ha pagado?')) return;
    
    try {
        const { error } = await supabase
            .from('barberias')
            .update({ 
                plan: 'premium',
                trial_hasta: null
            })
            .eq('id', barberiaId);

        if (!error) {
            alert('✅ Barbería marcada como Premium (pagada)');
            cargarFacturacion();
            cargarMetricas();
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}
        async function cargarReportes() {
    // Por ahora solo actualizamos el HTML con información básica
    // Aquí puedes agregar gráficos y reportes más complejos después
    console.log('Cargando reportes...');
}
    
// Verificar sesión al cargar
window.addEventListener('load', () => {
    const autenticado = sessionStorage.getItem('creadorAutenticado');
    if (autenticado === 'true') {
        mostrarPanel();
    }
});

function mostrarLoginCreador() {
    document.getElementById('formularioLogin').classList.remove('hidden');
}

function ocultarLoginCreador() {
    document.getElementById('formularioLogin').classList.add('hidden');
    document.getElementById('passwordCreador').value = '';
}

function validarLogin(e) {
    e.preventDefault();
    const password = document.getElementById('passwordCreador').value;
    
    if (password === 'admin123') {
        sessionStorage.setItem('creadorAutenticado', 'true');
        mostrarPanel();
    } else {
        alert('Contraseña incorrecta');
        document.getElementById('passwordCreador').value = '';
    }
}

function mostrarPanel() {
    document.getElementById('pantallaSeleccion').classList.add('hidden');
    document.getElementById('panelCreador').classList.remove('hidden');
    mostrarTab('dashboard');
}

function cerrarSesion() {
    if (confirm('¿Cerrar sesión?')) {
        sessionStorage.removeItem('creadorAutenticado');
        document.getElementById('panelCreador').classList.add('hidden');
        document.getElementById('pantallaSeleccion').classList.remove('hidden');
        ocultarLoginCreador();
    }
}


        // Función para cambiar entre tabs
        function mostrarTab(tabId) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            // Mostrar contenido seleccionado
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            
            // Activar botón seleccionado
            document.getElementById(`tab-${tabId}`).classList.add('bg-blue-600', 'text-white');
            document.getElementById(`tab-${tabId}`).classList.remove('text-gray-600');
            
            // Cargar datos específicos de cada tab
            switch(tabId) {
                case 'dashboard':
                    cargarMetricas();
                    break;
                case 'barberias':
                    cargarBarberias();
                    break;
                    
                case 'facturacion':
                    cargarFacturacion();
                    break;
                case 'reportes':
                     cargarReportes();
                    cargarBarberiasEnBackup();
                    break;
            }
        }
        // ===============================
        // FUNCIONES BACKUP Y EXPORTACIÓN
        // ===============================
        
        // Backup rápido desde card de barbería
        async function backupRapido(barberiaId, barberiaNombre) {
            try {
                console.log('📥 Iniciando backup rápido para:', barberiaNombre);
                
                // Mostrar loading
                const event = window.event;
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '⏳';
                btn.disabled = true;
                
                // Obtener todos los datos
                const datosCompletos = await obtenerDatosBarberia(barberiaId);
                
                // Exportar como Excel
                await exportarExcel(datosCompletos, barberiaNombre + '_backup_completo');
                
                // Restaurar botón
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                console.log('✅ Backup rápido completado');
                
            } catch (error) {
                console.error('❌ Error en backup rápido:', error);
                alert('❌ Error generando backup: ' + error.message);
                
                // Restaurar botón en caso de error
                const btn = event.target;
                btn.innerHTML = '📥';
                btn.disabled = false;
            }
        }
        
        // Backup avanzado con opciones
        async function exportarBackupAvanzado() {
            try {
                const barberiaId = document.getElementById('selectBarberiaBackup').value;
                const tipoBackup = document.getElementById('tipoBackup').value;
                const formato = document.getElementById('formatoBackup').value;
                
                if (!barberiaId) {
                    alert('⚠️ Por favor selecciona una barbería');
                    return;
                }
                
                console.log('📊 Iniciando backup avanzado:', { barberiaId, tipoBackup, formato });
                
                // Obtener nombre de barbería
                const { data: barberia } = await supabase
                    .from('barberias')
                    .select('nombre')
                    .eq('id', barberiaId)
                    .single();
                
                const barberiaNombre = barberia?.nombre || 'Barberia';
                
                // Obtener datos según tipo seleccionado
                let datos;
                let nombreArchivo;
                
                switch(tipoBackup) {
                    case 'completo':
                        datos = await obtenerDatosBarberia(barberiaId);
                        nombreArchivo = `${barberiaNombre}_backup_completo`;
                        break;
                    case 'usuarios':
                        datos = { usuarios: await obtenerUsuarios(barberiaId) };
                        nombreArchivo = `${barberiaNombre}_usuarios`;
                        break;
                    case 'servicios':
                        datos = { servicios: await obtenerServicios(barberiaId) };
                        nombreArchivo = `${barberiaNombre}_servicios`;
                        break;
                    case 'reservas':
                        datos = { reservas: await obtenerReservas(barberiaId) };
                        nombreArchivo = `${barberiaNombre}_reservas`;
                        break;
                    case 'adelantos':
                        datos = { adelantos: await obtenerAdelantos(barberiaId) };
                        nombreArchivo = `${barberiaNombre}_adelantos`;
                        break;
                    default:
                        throw new Error('Tipo de backup no válido');
                }
                
                // Exportar según formato
                switch(formato) {
                    case 'excel':
                        await exportarExcel(datos, nombreArchivo);
                        break;
                    case 'csv':
                        await exportarCSV(datos, nombreArchivo);
                        break;
                    case 'json':
                        await exportarJSON(datos, nombreArchivo);
                        break;
                    default:
                        throw new Error('Formato no válido');
                }
                
                console.log('✅ Backup avanzado completado');
                
            } catch (error) {
                console.error('❌ Error en backup avanzado:', error);
                alert('❌ Error generando backup: ' + error.message);
            }
        }
        
        // Obtener todos los datos de una barbería
        async function obtenerDatosBarberia(barberiaId) {
            console.log('📊 Recopilando datos completos...');
            
            const [barberia, usuarios, servicios, reservas, adelantos] = await Promise.all([
                obtenerInfoBarberia(barberiaId),
                obtenerUsuarios(barberiaId),
                obtenerServicios(barberiaId),
                obtenerReservas(barberiaId),
                obtenerAdelantos(barberiaId)
            ]);
            
            return {
                barberia,
                usuarios,
                servicios,
                reservas,
                adelantos,
                metadata: {
                    fecha_backup: new Date().toISOString(),
                    total_registros: usuarios.length + servicios.length + reservas.length + adelantos.length
                }
            };
        }
        
        // Funciones auxiliares para obtener datos
        async function obtenerInfoBarberia(barberiaId) {
            const { data } = await supabase
                .from('barberias')
                .select('*')
                .eq('id', barberiaId)
                .single();
            return data;
        }
        
        async function obtenerUsuarios(barberiaId) {
            const { data } = await supabase
                .from('usuarios')
                .select('*')
                .eq('barberia_id', barberiaId);
            return data || [];
        }
        
        async function obtenerServicios(barberiaId) {
            const { data } = await supabase
                .from('citas')
                .select('*')
                .eq('barberia_id', barberiaId);
            return data || [];
        }
        
        async function obtenerReservas(barberiaId) {
            const { data } = await supabase
                .from('reservas')
                .select('*')
                .eq('barberia_id', barberiaId);
            return data || [];
        }
        
        async function obtenerAdelantos(barberiaId) {
            const { data } = await supabase
                .from('adelantos')
                .select('*')
                .eq('barberia_id', barberiaId);
            return data || [];
        }
        
        // Funciones de exportación
        async function exportarExcel(datos, nombreArchivo) {
            console.log('📊 Generando archivo Excel...');
            
            // Crear contenido Excel simple (CSV con separador de tabulación)
            let contenido = '';
            
            Object.keys(datos).forEach(tabla => {
                if (Array.isArray(datos[tabla])) {
                    contenido += `\n=== ${tabla.toUpperCase()} ===\n`;
                    
                    if (datos[tabla].length > 0) {
                        // Headers
                        const headers = Object.keys(datos[tabla][0]);
                        contenido += headers.join('\t') + '\n';
                        
                        // Datos
                        datos[tabla].forEach(fila => {
                            const valores = headers.map(header => {
                                let valor = fila[header] || '';
                                // Limpiar datos para Excel
                                if (typeof valor === 'string') {
                                    valor = valor.replace(/\t/g, ' ').replace(/\n/g, ' ');
                                }
                                return valor;
                            });
                            contenido += valores.join('\t') + '\n';
                        });
                    } else {
                        contenido += 'Sin datos\n';
                    }
                    contenido += '\n';
                }
            });
            
            // Descargar archivo
            descargarArchivo(contenido, nombreArchivo + '.xls', 'application/vnd.ms-excel');
        }
        
        async function exportarCSV(datos, nombreArchivo) {
            console.log('📄 Generando archivo CSV...');
            
            let contenido = '';
            
            Object.keys(datos).forEach(tabla => {
                if (Array.isArray(datos[tabla]) && datos[tabla].length > 0) {
                    contenido += `\n=== ${tabla.toUpperCase()} ===\n`;
                    
                    // Headers
                    const headers = Object.keys(datos[tabla][0]);
                    contenido += headers.join(',') + '\n';
                    
                    // Datos
                    datos[tabla].forEach(fila => {
                        const valores = headers.map(header => {
                            let valor = fila[header] || '';
                            // Escapar comas y comillas para CSV
                            if (typeof valor === 'string' && (valor.includes(',') || valor.includes('"'))) {
                                valor = '"' + valor.replace(/"/g, '""') + '"';
                            }
                            return valor;
                        });
                        contenido += valores.join(',') + '\n';
                    });
                    contenido += '\n';
                }
            });
            
            descargarArchivo(contenido, nombreArchivo + '.csv', 'text/csv');
        }
        
        async function exportarJSON(datos, nombreArchivo) {
            console.log('🔧 Generando archivo JSON...');
            
            const contenido = JSON.stringify(datos, null, 2);
            descargarArchivo(contenido, nombreArchivo + '.json', 'application/json');
        }
        
        // Función auxiliar para descargar archivos
        function descargarArchivo(contenido, nombreArchivo, tipoMime) {
            const blob = new Blob([contenido], { type: tipoMime });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nombreArchivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            console.log('✅ Archivo descargado:', nombreArchivo);
        }
        
        // Cargar barberías en selector de backup
        async function cargarBarberiasEnBackup() {
            try {
                const { data: barberias } = await supabase
                    .from('barberias')
                    .select('id, nombre')
                    .order('nombre', { ascending: true });
                
                const select = document.getElementById('selectBarberiaBackup');
                select.innerHTML = '<option value="">Seleccionar barbería...</option>';
                
                if (barberias) {
                    barberias.forEach(barberia => {
                        const option = document.createElement('option');
                        option.value = barberia.id;
                        option.textContent = barberia.nombre;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('❌ Error cargando barberías para backup:', error);
            }
        }
        // ===============================
        // FUNCIONES ELIMINAR BARBERÍA COMPLETA
        // ===============================
        
        let barberiaAEliminar = null;
        
        async function mostrarModalEliminar(barberiaId, barberiaNombre) {
            console.log('🗑️ Preparando eliminación de:', barberiaNombre);
            barberiaAEliminar = { id: barberiaId, nombre: barberiaNombre };
            
            // Mostrar loading en resumen
            document.getElementById('resumenEliminacion').innerHTML = `
                <div class="text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <p class="text-sm text-gray-600 mt-2">Analizando datos...</p>
                </div>
            `;
            
            // Mostrar modal
            document.getElementById('modalEliminarBarberia').classList.remove('hidden');
            
            // Cargar resumen de datos
            await cargarResumenEliminacion(barberiaId, barberiaNombre);
        }
        
        async function cargarResumenEliminacion(barberiaId, barberiaNombre) {
            try {
                // Contar usuarios
                const { count: usuarios } = await supabase
                    .from('usuarios')
                    .select('*', { count: 'exact', head: true })
                    .eq('barberia_id', barberiaId);
                
                // Contar citas
                const { count: citas } = await supabase
                    .from('citas')
                    .select('*', { count: 'exact', head: true })
                    .eq('barberia_id', barberiaId);
                
                // Contar adelantos
                const { count: adelantos } = await supabase
                    .from('adelantos')
                    .select('*', { count: 'exact', head: true })
                    .eq('barberia_id', barberiaId);
                
                // Contar reservas
                const { count: reservas } = await supabase
                    .from('reservas')
                    .select('*', { count: 'exact', head: true })
                    .eq('barberia_id', barberiaId);
                
                // Mostrar resumen
                document.getElementById('resumenEliminacion').innerHTML = `
                    <div class="space-y-3">
                        <div class="text-center mb-4">
                            <h4 class="font-bold text-lg text-gray-800">"${barberiaNombre}"</h4>
                            <p class="text-sm text-gray-600">ID: ${barberiaId.substring(0, 8)}...</p>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-700">👥 Usuarios:</span>
                                <span class="font-semibold">${usuarios || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">✂️ Servicios registrados:</span>
                                <span class="font-semibold">${citas || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">💰 Adelantos:</span>
                                <span class="font-semibold">${adelantos || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">📅 Reservas:</span>
                                <span class="font-semibold">${reservas || 0}</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold text-red-600">
                                <span>📊 Total registros:</span>
                                <span>${(usuarios || 0) + (citas || 0) + (adelantos || 0) + (reservas || 0) + 1}</span>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('❌ Error cargando resumen:', error);
                document.getElementById('resumenEliminacion').innerHTML = `
                    <div class="text-red-600 text-center">
                        ❌ Error cargando datos
                    </div>
                `;
            }
        }
        
        function cerrarModalEliminar() {
            document.getElementById('modalEliminarBarberia').classList.add('hidden');
            barberiaAEliminar = null;
        }
        
        async function confirmarEliminacion() {
            if (!barberiaAEliminar) return;
            
            // Mostrar loading
            document.getElementById('loadingEliminacion').classList.remove('hidden');
            
            try {
                console.log('🗑️ Iniciando eliminación cascada para:', barberiaAEliminar.nombre);
                
                const barberiaId = barberiaAEliminar.id;
                
                // PASO 1: Eliminar reservas
                console.log('🔄 Eliminando reservas...');
                const { error: errorReservas } = await supabase
                    .from('reservas')
                    .delete()
                    .eq('barberia_id', barberiaId);
                
                if (errorReservas) throw new Error('Error eliminando reservas: ' + errorReservas.message);
                
                // PASO 2: Eliminar adelantos
                console.log('🔄 Eliminando adelantos...');
                const { error: errorAdelantos } = await supabase
                    .from('adelantos')
                    .delete()
                    .eq('barberia_id', barberiaId);
                
                if (errorAdelantos) throw new Error('Error eliminando adelantos: ' + errorAdelantos.message);
                
                // PASO 3: Eliminar citas
                console.log('🔄 Eliminando citas...');
                const { error: errorCitas } = await supabase
                    .from('citas')
                    .delete()
                    .eq('barberia_id', barberiaId);
                
                if (errorCitas) throw new Error('Error eliminando citas: ' + errorCitas.message);
                
                // PASO 4: Eliminar usuarios
                console.log('🔄 Eliminando usuarios...');
                const { error: errorUsuarios } = await supabase
                    .from('usuarios')
                    .delete()
                    .eq('barberia_id', barberiaId);
                
                if (errorUsuarios) throw new Error('Error eliminando usuarios: ' + errorUsuarios.message);
                
                // PASO 5: Eliminar barbería
                console.log('🔄 Eliminando barbería...');
                const { error: errorBarberia } = await supabase
                    .from('barberias')
                    .delete()
                    .eq('id', barberiaId);
                
                if (errorBarberia) throw new Error('Error eliminando barbería: ' + errorBarberia.message);
                
                console.log('✅ Eliminación cascada completada exitosamente');
                
                // Éxito
                alert(`✅ Barbería "${barberiaAEliminar.nombre}" eliminada completamente.\n\nTodos los datos han sido removidos de la base de datos.`);
                
                // Cerrar modal y recargar datos
                cerrarModalEliminar();
                cargarBarberias();
                cargarMetricas();
                
            } catch (error) {
                console.error('❌ Error en eliminación:', error);
                alert('❌ Error eliminando barbería: ' + error.message);
            } finally {
                document.getElementById('loadingEliminacion').classList.add('hidden');
            }
        }
        // ===============================
// CONSULTOR IA - FUNCIONES
// ===============================

let datosAnalisisIA = {
    barberiaId: null,
    barberiaNombre: null,
    servicios: [],
    barberos: [],
    adelantos: []
};

async function mostrarConsultorIA(barberiaId, barberiaNombre) {
    console.log('📊 Abriendo Consultor IA para:', barberiaNombre);
    
    // Mostrar modal
    document.getElementById('modalConsultorIA').classList.remove('hidden');
    document.getElementById('nombreBarberiaIA').textContent = barberiaNombre;
    document.getElementById('loadingIA').classList.remove('hidden');
    document.getElementById('contenidoIA').classList.add('hidden');
    
    // Guardar datos
    datosAnalisisIA.barberiaId = barberiaId;
    datosAnalisisIA.barberiaNombre = barberiaNombre;
    
    try {
        // Cargar datos de últimos 30 días
        const hace30Dias = new Date();
        hace30Dias.setDate(hace30Dias.getDate() - 30);
        const fechaInicio = hace30Dias.toISOString().split('T')[0];
        
        // Cargar servicios
        const { data: servicios, error: errorServicios } = await supabase
            .from('citas')
            .select('*')
            .eq('barberia_id', barberiaId)
            .gte('fecha', fechaInicio);
        
        if (errorServicios) throw errorServicios;
        
        // Cargar barberos
        const { data: barberos, error: errorBarberos } = await supabase
            .from('usuarios')
            .select('*')
            .eq('barberia_id', barberiaId)
            .eq('activo', true);
        
        if (errorBarberos) throw errorBarberos;
        
        // Guardar datos
        datosAnalisisIA.servicios = servicios || [];
        datosAnalisisIA.barberos = barberos || [];
        
        if (datosAnalisisIA.servicios.length === 0) {
            mostrarSinDatosIA();
        } else {
            // Generar análisis
            generarAnalisisCompleto();
        }
        
    } catch (error) {
        console.error('❌ Error:', error);
        alert('Error al cargar datos del análisis');
        cerrarModalIA();
    }
}

function generarAnalisisCompleto() {
    console.log('🧠 Generando análisis completo...');
    
    // 1. Calcular todas las métricas
    calcularSaludIA();
    calcularAnalisisIngresos();
    calcularAnalisisServicios();
    calcularAnalisisTemporal();
    calcularAnalisisBarberos();
    
    // 2. Generar recomendaciones
    generarRecomendacionesIA();
    
    // 3. Calcular proyección
    calcularProyeccionIA();
    
    // 4. Generar plan de acción
    generarPlanAccion();
    
    // 5. Actualizar footer
    document.getElementById('nombreBarberiaFooter').textContent = datosAnalisisIA.barberiaNombre;
    
    // Mostrar contenido
    document.getElementById('loadingIA').classList.add('hidden');
    document.getElementById('contenidoIA').classList.remove('hidden');
}

function calcularSaludIA() {
    const { servicios } = datosAnalisisIA;
    
    // Calcular métricas (UNA SOLA VEZ)
    const totalIngresos = servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0);
    const ticketPromedio = Math.round(totalIngresos / servicios.length);
    const serviciosPorDia = (servicios.length / 30).toFixed(1);
    
    let puntos = 0;
    
    // Criterios de puntuación
    if (totalIngresos > 1000000) puntos += 40;
    else if (totalIngresos > 500000) puntos += 30;
    else if (totalIngresos > 250000) puntos += 20;
    else puntos += 10;
    
    if (ticketPromedio > 18000) puntos += 30;
    else if (ticketPromedio > 15000) puntos += 20;
    else if (ticketPromedio > 12000) puntos += 10;
    
    if (serviciosPorDia > 15) puntos += 30;
    else if (serviciosPorDia > 10) puntos += 20;
    else if (serviciosPorDia > 5) puntos += 10;
    
    // Determinar estado
    let emoji, mensaje, color;
    
    if (puntos >= 80) {
        emoji = '🟢';
        mensaje = '¡EXCELENTE! Tu barbería va muy bien';
        color = 'text-green-600';
    } else if (puntos >= 60) {
        emoji = '🔵';
        mensaje = 'BIEN - Puedes mejorar algunas cosas';
        color = 'text-blue-600';
    } else if (puntos >= 40) {
        emoji = '🟡';
        mensaje = 'REGULAR - Necesitas hacer cambios';
        color = 'text-yellow-600';
    } else {
        emoji = '🔴';
        mensaje = 'URGENTE - Requiere atención';
        color = 'text-red-600';
    }
    
    document.getElementById('emojiSaludIA').textContent = emoji;
    document.getElementById('puntajeSaludIA').textContent = `${puntos}/100`;
    document.getElementById('puntajeSaludIA').className = `text-5xl font-bold mb-3 ${color}`;
    document.getElementById('mensajeSaludIA').textContent = mensaje;
    
    // Llenar métricas del PDF (REUTILIZANDO las variables ya calculadas)
    document.getElementById('totalServiciosPDF').textContent = servicios.length;
    document.getElementById('totalIngresosPDF').textContent = `$${totalIngresos.toLocaleString('es-CL')}`;
    document.getElementById('ticketPromedioPDF').textContent = `$${ticketPromedio.toLocaleString('es-CL')}`;
    document.getElementById('serviciosDiaPDF').textContent = serviciosPorDia;
}

function generarRecomendacionesIA() {
    const { servicios } = datosAnalisisIA;
    const recomendaciones = [];
    
    const totalIngresos = servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0);
    const ticketPromedio = Math.round(totalIngresos / servicios.length);
    
    // RECOMENDACIÓN 1: Ticket Promedio Bajo
    if (ticketPromedio < 15000) {
        recomendaciones.push({
            icono: '💰',
            titulo: 'GANAR MÁS - Ticket promedio bajo',
            problema: `Tus clientes gastan solo $${ticketPromedio.toLocaleString('es-CL')} por visita`,
            solucion: 'Ofrece servicios adicionales: "¿Le agregamos barba por $8.000?"',
            impacto: `Si 1 de cada 3 acepta, ganarás $${Math.round(servicios.length / 3 * 8000).toLocaleString('es-CL')} extra`,
            color: 'from-green-400 to-green-600'
        });
    }
    
    // RECOMENDACIÓN 2: Servicio Popular
    const servicioStats = {};
    servicios.forEach(s => {
        const servicio = s.servicio_principal_nombre;
        if (!servicioStats[servicio]) {
            servicioStats[servicio] = { count: 0, total: 0 };
        }
        servicioStats[servicio].count++;
        servicioStats[servicio].total += parseFloat(s.monto_total);
    });
    
    const servicioTop = Object.entries(servicioStats).sort((a, b) => b[1].count - a[1].count)[0];
    if (servicioTop && servicioTop[1].count > servicios.length * 0.25) {
        const precioActual = Math.round(servicioTop[1].total / servicioTop[1].count);
        const precioNuevo = Math.round(precioActual * 1.10);
        const ganancia = (precioNuevo - precioActual) * servicioTop[1].count;
        
        recomendaciones.push({
            icono: '🔥',
            titulo: 'OPORTUNIDAD - Tu servicio estrella',
            problema: `"${servicioTop[0]}" es tu más vendido (${servicioTop[1].count} veces)`,
            solucion: `Sube precio de $${precioActual.toLocaleString('es-CL')} a $${precioNuevo.toLocaleString('es-CL')} (+10%)`,
            impacto: `Ganarás $${ganancia.toLocaleString('es-CL')} extra este mes`,
            color: 'from-purple-400 to-purple-600'
        });
    }
    
    // RECOMENDACIÓN 3: Días Flojos
    const porDia = {};
    const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    
    servicios.forEach(s => {
        const fecha = new Date(s.fecha + 'T00:00:00');
        const dia = fecha.getDay();
        porDia[dia] = (porDia[dia] || 0) + 1;
    });
    
    const diaBajo = Object.entries(porDia).sort((a, b) => a[1] - b[1])[0];
    const promedio = Object.values(porDia).reduce((a, b) => a + b, 0) / Object.keys(porDia).length;
    
    if (diaBajo && diaBajo[1] < promedio * 0.6) {
        const potencial = Math.round((promedio - diaBajo[1]) * ticketPromedio * 4);
        
        recomendaciones.push({
            icono: '📅',
            titulo: 'OPTIMIZAR - Día flojo detectado',
            problema: `Los ${diasSemana[diaBajo[0]]}s tienen pocos clientes (${diaBajo[1]} servicios)`,
            solucion: `Promoción especial SOLO ${diasSemana[diaBajo[0]]}s: "2x1" o "30% OFF"`,
            impacto: `Puedes ganar $${potencial.toLocaleString('es-CL')} extra al mes`,
            color: 'from-yellow-400 to-yellow-600'
        });
    }
    
    // Mostrar recomendaciones
    const container = document.getElementById('recomendacionesIA');
    
    if (recomendaciones.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">✅ Todo bien! No hay recomendaciones urgentes</div>';
        return;
    }
    
    container.innerHTML = recomendaciones.slice(0, 3).map((rec, i) => `
        <div class="bg-gradient-to-r ${rec.color} text-white rounded-lg p-5 shadow-lg">
            <div class="flex items-start">
                <div class="text-3xl mr-4">${rec.icono}</div>
                <div class="flex-1">
                    <h5 class="font-bold text-lg mb-2">${i + 1}. ${rec.titulo}</h5>
                    <p class="text-sm opacity-90 mb-2">📊 ${rec.problema}</p>
                    <p class="text-sm font-semibold mb-2">✅ ${rec.solucion}</p>
                    <p class="text-sm bg-white bg-opacity-20 rounded px-3 py-1 inline-block">💰 ${rec.impacto}</p>
                </div>
            </div>
        </div>
    `).join('');
    // Generar resumen de recomendaciones para sección 1
    const resumen = recomendaciones.slice(0, 3).map((rec, i) => 
        `<div class="text-sm">• ${rec.titulo.split(' - ')[1] || rec.titulo}</div>`
    ).join('');
    
    document.getElementById('resumenRecomendaciones').innerHTML = resumen || '<div class="text-sm text-gray-500">No hay recomendaciones urgentes</div>';
    
    
}

function calcularProyeccionIA() {
    const { servicios } = datosAnalisisIA;
    
    const totalIngresos = servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0);
    const serviciosPorDia = (servicios.length / 30).toFixed(1); // Muestra 1 decimal
    const ticketPromedio = Math.round(totalIngresos / servicios.length);
    
    const proyeccion = Math.round(serviciosPorDia * 30 * ticketPromedio);
    const meta = Math.round(proyeccion * 1.10);
    
    document.getElementById('proyeccionIA').textContent = `$${proyeccion.toLocaleString('es-CL')}`;
    document.getElementById('metaIA').textContent = `$${meta.toLocaleString('es-CL')}`;
    document.getElementById('explicacionProyeccionIA').textContent = 
    `Basado en ${serviciosPorDia} servicios/día × $${ticketPromedio.toLocaleString('es-CL')} ticket promedio`;

}

function mostrarSinDatosIA() {
    document.getElementById('loadingIA').classList.add('hidden');
    document.getElementById('contenidoIA').classList.remove('hidden');
    document.getElementById('recomendacionesIA').innerHTML = `
        <div class="text-center py-12">
            <div class="text-6xl mb-4">📊</div>
            <p class="text-xl text-gray-600">Sin datos suficientes para analizar</p>
            <p class="text-gray-500 mt-2">Esta barbería no tiene servicios registrados en los últimos 30 días</p>
        </div>
    `;
}
// ===============================
// ANÁLISIS DE INGRESOS
// ===============================

function calcularAnalisisIngresos() {
    const { servicios } = datosAnalisisIA;
    
    // Formas de pago
    const formasPago = { 'Efectivo': 0, 'Cuenta RUT': 0, 'Mercado Pago': 0 };
    const montoPorForma = { 'Efectivo': 0, 'Cuenta RUT': 0, 'Mercado Pago': 0 };
    
    servicios.forEach(s => {
        const forma = s.forma_pago || 'Efectivo';
        const monto = parseFloat(s.monto_total || 0);
        formasPago[forma] = (formasPago[forma] || 0) + 1;
        montoPorForma[forma] = (montoPorForma[forma] || 0) + monto;
    });
    
    const total = servicios.length;
    const totalIngresos = servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0);
    
    // Renderizar formas de pago
    let htmlFormas = '';
    Object.entries(formasPago).forEach(([forma, count]) => {
        const porcentaje = Math.round((count / total) * 100);
        const monto = montoPorForma[forma];
        const ticketProm = Math.round(monto / count);
        const color = forma === 'Efectivo' ? 'green' : forma === 'Cuenta RUT' ? 'blue' : 'purple';
        
        htmlFormas += `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                <div class="flex items-center flex-1">
                    <div class="w-32">
                        <span class="font-semibold">${forma}</span>
                    </div>
                    <div class="flex-1">
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-${color}-500 h-3 rounded-full" style="width: ${porcentaje}%"></div>
                        </div>
                    </div>
                </div>
                <div class="ml-4 text-right">
                    <div class="font-bold text-${color}-600">$${monto.toLocaleString('es-CL')}</div>
                    <div class="text-xs text-gray-500">${count} servicios (${porcentaje}%) · Prom: $${ticketProm.toLocaleString('es-CL')}</div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('formasPagoDetalle').innerHTML = htmlFormas;
    
    // Análisis de ticket
    const ticketPromedio = Math.round(totalIngresos / servicios.length);
    const ticketEfectivo = Math.round(montoPorForma['Efectivo'] / formasPago['Efectivo']);
    const ticketTarjeta = Math.round((montoPorForma['Cuenta RUT'] + montoPorForma['Mercado Pago']) / (formasPago['Cuenta RUT'] + formasPago['Mercado Pago']));
    
    const diferencia = ticketTarjeta - ticketEfectivo;
    const porcentajeDif = Math.round((diferencia / ticketEfectivo) * 100);
    
    document.getElementById('ticketAnalisis').innerHTML = `
        <div class="flex justify-between">
            <span>Ticket Promedio General:</span>
            <span class="font-bold">$${ticketPromedio.toLocaleString('es-CL')}</span>
        </div>
        <div class="flex justify-between">
            <span>Ticket con Efectivo:</span>
            <span class="font-bold text-green-600">$${ticketEfectivo.toLocaleString('es-CL')}</span>
        </div>
        <div class="flex justify-between">
            <span>Ticket con Tarjeta:</span>
            <span class="font-bold text-blue-600">$${ticketTarjeta.toLocaleString('es-CL')}</span>
        </div>
        <div class="mt-2 p-2 bg-yellow-50 rounded text-xs">
            💡 <strong>Insight:</strong> Los clientes con tarjeta gastan ${porcentajeDif > 0 ? porcentajeDif + '% MÁS' : 'igual'} que con efectivo
        </div>
    `;
}

// ===============================
// ANÁLISIS DE SERVICIOS
// ===============================

function calcularAnalisisServicios() {
    const { servicios } = datosAnalisisIA;
    
    // Agrupar por servicio
    const stats = {};
    servicios.forEach(s => {
        const nombre = s.servicio_principal_nombre;
        if (!stats[nombre]) {
            stats[nombre] = { count: 0, total: 0 };
        }
        stats[nombre].count++;
        stats[nombre].total += parseFloat(s.monto_total || 0);
    });
    
    // Top 5 más vendidos
    const top5 = Object.entries(stats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 5);
    
    const totalServicios = servicios.length;
    
    let htmlTop5 = '';
    top5.forEach(([nombre, data], index) => {
        const porcentaje = Math.round((data.count / totalServicios) * 100);
        const promedio = Math.round(data.total / data.count);
        const medalla = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🔹';
        
        htmlTop5 += `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                <div class="flex items-center flex-1">
                    <span class="text-2xl mr-3">${medalla}</span>
                    <div class="flex-1">
                        <div class="font-semibold">${nombre}</div>
                        <div class="text-xs text-gray-500">${data.count} servicios (${porcentaje}%)</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-green-600">$${data.total.toLocaleString('es-CL')}</div>
                    <div class="text-xs text-gray-500">Prom: $${promedio.toLocaleString('es-CL')}</div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('top5Servicios').innerHTML = htmlTop5;
    
    // Más rentables (mayor ingreso total)
    const masRentables = Object.entries(stats)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 3);
    
    let htmlRentables = masRentables.map(([nombre, data]) => {
        const promedio = Math.round(data.total / data.count);
        return `
            <div class="flex justify-between items-center">
                <span class="font-semibold">${nombre}</span>
                <span class="text-green-600 font-bold">$${data.total.toLocaleString('es-CL')} (${data.count} × $${promedio.toLocaleString('es-CL')})</span>
            </div>
        `;
    }).join('');
    
    document.getElementById('serviciosRentables').innerHTML = htmlRentables;
}

// ===============================
// ANÁLISIS TEMPORAL
// ===============================

function calcularAnalisisTemporal() {
    const { servicios } = datosAnalisisIA;
    
    const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    const porDia = {};
    const porHora = {};
    
    servicios.forEach(s => {
        // Por día
        const fecha = new Date(s.fecha + 'T00:00:00');
        const dia = fecha.getDay();
        if (!porDia[dia]) {
            porDia[dia] = { count: 0, ingresos: 0 };
        }
        porDia[dia].count++;
        porDia[dia].ingresos += parseFloat(s.monto_total || 0);
        
        // Por hora
        if (s.created_at) {
            const hora = parseInt(s.created_at.split('T')[1]?.split(':')[0] || '12');
            const bloqueHora = Math.floor(hora / 2) * 2; // Bloques de 2 horas
            if (!porHora[bloqueHora]) {
                porHora[bloqueHora] = { count: 0, ingresos: 0 };
            }
            porHora[bloqueHora].count++;
            porHora[bloqueHora].ingresos += parseFloat(s.monto_total || 0);
        }
    });
    
    // Renderizar días
    const totalServicios = servicios.length;
    const maxDia = Math.max(...Object.values(porDia).map(d => d.count));
    
    let htmlDias = '';
    for (let i = 0; i < 7; i++) {
        const data = porDia[i] || { count: 0, ingresos: 0 };
        const porcentaje = totalServicios > 0 ? Math.round((data.count / totalServicios) * 100) : 0;
        const barWidth = maxDia > 0 ? Math.round((data.count / maxDia) * 100) : 0;
        
        htmlDias += `
            <div class="flex items-center gap-3">
                <div class="w-24 font-medium">${diasSemana[i]}</div>
                <div class="flex-1">
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-blue-500 h-4 rounded-full flex items-center justify-end pr-2" style="width: ${barWidth}%">
                            ${data.count > 0 ? `<span class="text-xs text-white font-bold">${data.count}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="w-32 text-right text-sm">
                    <div class="font-bold">${porcentaje}%</div>
                    <div class="text-xs text-gray-500">$${data.ingresos.toLocaleString('es-CL')}</div>
                </div>
            </div>
        `;
    }
    
    document.getElementById('distribucionDias').innerHTML = htmlDias;
    
    // Renderizar horas
    const maxHora = Math.max(...Object.values(porHora).map(h => h.count));
    
    let htmlHoras = '';
    for (let h = 10; h < 20; h += 2) {
        const data = porHora[h] || { count: 0, ingresos: 0 };
        const barWidth = maxHora > 0 ? Math.round((data.count / maxHora) * 100) : 0;
        
        htmlHoras += `
            <div class="flex items-center gap-3">
                <div class="w-20 font-medium text-sm">${h}:00-${h+2}:00</div>
                <div class="flex-1">
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-orange-500 h-3 rounded-full" style="width: ${barWidth}%"></div>
                    </div>
                </div>
                <div class="w-24 text-right text-xs">
                    <span class="font-bold">${data.count} servicios</span>
                </div>
            </div>
        `;
    }
    
    document.getElementById('distribucionHoras').innerHTML = htmlHoras;
}

// ===============================
// ANÁLISIS DE BARBEROS
// ===============================

function calcularAnalisisBarberos() {
    const { servicios } = datosAnalisisIA;
    
    const stats = {};
    
    servicios.forEach(s => {
        const id = s.realizado_por_id;
        const nombre = s.realizado_por_nombre;
        
        if (!stats[id]) {
            stats[id] = { nombre, count: 0, ingresos: 0 };
        }
        stats[id].count++;
        stats[id].ingresos += parseFloat(s.monto_total || 0);
    });
    
    const ranking = Object.values(stats).sort((a, b) => b.ingresos - a.ingresos);
    
    // Renderizar ranking
    let htmlRanking = '';
    ranking.forEach((barbero, index) => {
        const promedio = Math.round(barbero.ingresos / barbero.count);
        const medalla = index === 0 ? '👑' : index === 1 ? '🥈' : index === 2 ? '🥉' : '👤';
        const color = index === 0 ? 'yellow' : index === 1 ? 'gray' : index === 2 ? 'orange' : 'blue';
        
        htmlRanking += `
            <div class="bg-${color}-50 border border-${color}-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${medalla}</span>
                        <div>
                            <div class="font-bold text-lg">${barbero.nombre}</div>
                            <div class="text-sm text-gray-600">${barbero.count} servicios · $${promedio.toLocaleString('es-CL')}/servicio</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-${color}-600">$${barbero.ingresos.toLocaleString('es-CL')}</div>
                        <div class="text-xs text-gray-500">${Math.round((barbero.ingresos / servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0)) * 100)}% del total</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('rankingBarberos').innerHTML = htmlRanking;
    
    // Alertas
    let htmlAlertas = '';
    
    if (ranking.length > 1) {
        const diferencia = ranking[0].ingresos - ranking[ranking.length - 1].ingresos;
        const porcentaje = Math.round((diferencia / ranking[0].ingresos) * 100);
        
        if (porcentaje > 30) {
            htmlAlertas += `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <span class="text-2xl mr-3">
                        <span class="text-2xl mr-3">⚠️</span>
                        <div>
                            <div class="font-bold text-red-700">Alerta: Gran diferencia de rendimiento</div>
                            <div class="text-sm text-gray-700 mt-1">
                                ${ranking[ranking.length - 1].nombre} está generando $${diferencia.toLocaleString('es-CL')} MENOS que ${ranking[0].nombre} (${porcentaje}% menos).
                                <strong>Acción requerida:</strong> Hablar con ${ranking[ranking.length - 1].nombre} HOY para identificar el problema.
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    document.getElementById('alertasBarberos').innerHTML = htmlAlertas || '<div class="text-center text-gray-500 py-4">✅ No hay alertas de barberos</div>';
}

// ===============================
// PLAN DE ACCIÓN
// ===============================

function generarPlanAccion() {
    const { servicios } = datosAnalisisIA;
    
    if (servicios.length === 0) {
        document.getElementById('planAccion').innerHTML = '<p class="text-gray-500">No hay datos para generar plan de acción</p>';
        return;
    }
    
    const acciones = [];
    
    // Acción 1: Implementar top recomendación
    const recomendaciones = document.querySelectorAll('#recomendacionesIA > div');
    if (recomendaciones.length > 0) {
        const primeraRec = recomendaciones[0].querySelector('h5')?.textContent;
        acciones.push({
            dia: 'Día 1-2',
            accion: primeraRec || 'Implementar recomendación principal',
            responsable: 'Administrador'
        });
    }
    
    // Acción 2: Ajustar precios
    acciones.push({
        dia: 'Día 3-4',
        accion: 'Revisar y ajustar precios de servicios populares',
        responsable: 'Administrador'
    });
    
    // Acción 3: Capacitación
    acciones.push({
        dia: 'Día 5-6',
        accion: 'Capacitar equipo en upselling (ofrecer servicios adicionales)',
        responsable: 'Todos los barberos'
    });
    
    // Acción 4: Promoción
    acciones.push({
        dia: 'Día 7',
        accion: 'Lanzar promoción para horarios/días flojos',
        responsable: 'Administrador'
    });
    
    let htmlPlan = acciones.map(a => `
        <div class="flex items-start p-2 border-l-4 border-blue-400 pl-3">
            <div class="flex-1">
                <div class="font-bold text-blue-700">${a.dia}</div>
                <div class="text-sm mt-1">${a.accion}</div>
            </div>
            <div class="text-xs text-gray-500 ml-2">${a.responsable}</div>
        </div>
    `).join('');
    
    document.getElementById('planAccion').innerHTML = htmlPlan;
}
        
function cerrarModalIA() {
    document.getElementById('modalConsultorIA').classList.add('hidden');
}

function descargarInformePDF() {
    const { barberiaNombre, servicios } = datosAnalisisIA;
    
    // Validar datos
    if (!servicios || servicios.length === 0) {
        alert('⚠️ No hay datos suficientes para generar el informe.\n\nEsta barbería necesita tener servicios registrados en los últimos 30 días.');
        return;
    }
    
    // Mostrar loading
    const btnDescargar = event.target;
    const textoOriginal = btnDescargar.innerHTML;
    btnDescargar.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Generando PDF Completo...';
    btnDescargar.disabled = true;
    
    // Preparar header del PDF
    document.getElementById('nombreBarberiaPDF').textContent = barberiaNombre;
    document.getElementById('fechaPDF').textContent = new Date().toLocaleDateString('es-CL', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    document.getElementById('headerPDF').classList.remove('hidden');
    
    // Configurar elemento a convertir
    const element = document.getElementById('contenidoIA');
    
    // Configuración del PDF optimizada para informe completo
    const opt = {
        margin: [8, 8, 8, 8],
        filename: `Informe-Completo-IA-${barberiaNombre.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            letterRendering: true,
            scrollY: 0,
            scrollX: 0,
            windowHeight: element.scrollHeight + 100
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            compress: true
        },
        pagebreak: { 
            mode: ['avoid-all', 'css', 'legacy'],
            before: '.page-break-before',
            after: '.page-break-after',
            avoid: ['tr', '.avoid-break']
        }
    };
    
    // Generar PDF
    html2pdf().set(opt).from(element).save().then(() => {
        console.log('✅ PDF completo generado exitosamente');
        
        // Ocultar header del PDF
        document.getElementById('headerPDF').classList.add('hidden');
        
        // Restaurar botón
        btnDescargar.innerHTML = textoOriginal;
        btnDescargar.disabled = false;
        
        // Mostrar confirmación mejorada
        const mensaje = document.createElement('div');
        mensaje.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-fade-in';
        mensaje.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle text-2xl mr-3"></i>
                <div>
                    <div class="font-bold">¡PDF Descargado!</div>
                    <div class="text-sm opacity-90">Informe completo de ${barberiaNombre}</div>
                </div>
            </div>
        `;
        document.body.appendChild(mensaje);
        
        setTimeout(() => {
            mensaje.style.transition = 'opacity 0.5s';
            mensaje.style.opacity = '0';
            setTimeout(() => mensaje.remove(), 500);
        }, 4000);
    }).catch(error => {
        console.error('❌ Error generando PDF:', error);
        
        // Error más descriptivo
        let mensajeError = 'Error al generar el PDF.';
        if (error.message?.includes('Canvas')) {
            mensajeError += '\n\nIntenta cerrar otros modales o recargar la página.';
        }
        
        alert(mensajeError);
        
        document.getElementById('headerPDF').classList.add('hidden');
        btnDescargar.innerHTML = textoOriginal;
        btnDescargar.disabled = false;
    });
}
        // ========== FIN DEL CÓDIGO NUEVO ==========
 
    </script>
</body>
</html>
